services:
  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: ims-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    ports:
      - "${POSTGRES_PORT:-54322}:5432" # Host 54322 -> Container 5432
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ims-network

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: ims-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${STORAGE_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${STORAGE_SECRET_KEY:-minioadmin}
    ports:
      - "${STORAGE_PORT:-9000}:9000" # MinIO API
      - "${STORAGE_CONSOLE_PORT:-9001}:9001" # MinIO Console
    volumes:
      - minio_data:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:9000/minio/health/live || exit 1",
        ]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 10s
    networks:
      - ims-network

  # Next.js (Bun) Application
  # app:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: ims-app
  #   restart: unless-stopped
  #   ports:
  #     - "${APP_PORT:-3000}:3000"
  #   environment:
  #     NODE_ENV: ${NODE_ENV:-production}
  #     DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-postgres}?schema=public
  #     DIRECT_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-postgres}?schema=public
  #     # MinIO Storage Configuration
  #     STORAGE_ENDPOINT: minio
  #     STORAGE_PORT: 9000
  #     STORAGE_USE_SSL: ${STORAGE_USE_SSL:-false}
  #     STORAGE_ACCESS_KEY: ${STORAGE_ACCESS_KEY:-minioadmin}
  #     STORAGE_SECRET_KEY: ${STORAGE_SECRET_KEY:-minioadmin}
  #     STORAGE_BUCKET: ${STORAGE_BUCKET:-ims-files}
  #     STORAGE_URL: ${STORAGE_URL:-http://localhost:9000}
  #     NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     minio:
  #       condition: service_healthy
  #   networks:
  #     - ims-network
  #   # Run migrations on startup (optional)
  #   # This assumes your Dockerfile's CMD is ["bun", "server.js"]
  #   # command: >
  #   #   sh -c "
  #   #     bunx prisma migrate deploy &&
  #   #     bun server.js
  #   #   "

volumes:
  postgres_data_dev:
    driver: local
  minio_data:
    driver: local

networks:
  ims-network:
    driver: bridge
